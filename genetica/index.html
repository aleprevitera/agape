<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Genetica Medica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        header {
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stats {
            font-size: 0.875rem;
            color: #666;
        }

        .progress-bar {
            height: 3px;
            background: #e0e0e0;
            margin-top: 16px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a1a1a;
            transition: width 0.3s ease;
        }

        .question-card {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .question-number {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option {
            padding: 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9375rem;
            text-align: left;
            background: #fff;
        }

        .option:hover:not(.disabled) {
            border-color: #999;
            background: #fafafa;
        }

        .option.correct {
            border-color: #22863a;
            background: #dcffe4;
            color: #22863a;
        }

        .option.wrong {
            border-color: #cb2431;
            background: #ffeef0;
            color: #cb2431;
        }

        .option.show-correct {
            border-color: #22863a;
            background: #dcffe4;
        }

        .option.disabled {
            cursor: default;
        }

        .feedback {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            display: none;
        }

        .feedback.visible {
            display: block;
        }

        .feedback.correct {
            background: #dcffe4;
            color: #22863a;
        }

        .feedback.wrong {
            background: #ffeef0;
            color: #cb2431;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: #1a1a1a;
            color: #fff;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: #fff;
            color: #1a1a1a;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .results {
            text-align: center;
            padding: 48px 24px;
        }

        .results h2 {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .score {
            font-size: 3rem;
            font-weight: 700;
            margin: 24px 0;
        }

        .score-label {
            color: #666;
            font-size: 0.875rem;
        }

        .results-breakdown {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin: 24px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .breakdown-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .start-screen {
            text-align: center;
            padding: 48px 24px;
        }

        .start-screen h1 {
            font-size: 2rem;
            margin-bottom: 16px;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 32px;
        }

        .mode-select {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 300px;
            margin: 0 auto 24px;
        }

        .mode-option {
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .mode-option:hover {
            border-color: #999;
        }

        .mode-option.selected {
            border-color: #1a1a1a;
            background: #f5f5f5;
        }

        .mode-option.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .mode-option strong {
            display: block;
            margin-bottom: 2px;
        }

        .mode-option span {
            font-size: 0.8125rem;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        .review-section {
            margin-top: 32px;
            text-align: left;
        }

        .review-section h3 {
            font-size: 1rem;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .review-item {
            padding: 16px;
            background: #fff;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #cb2431;
        }

        .review-question {
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9375rem;
        }

        .review-your {
            font-size: 0.8125rem;
            color: #cb2431;
            margin-bottom: 4px;
        }

        .review-correct {
            font-size: 0.8125rem;
            color: #22863a;
        }

        .loading {
            text-align: center;
            padding: 80px 24px;
            color: #666;
        }

        .error-screen {
            text-align: center;
            padding: 80px 24px;
        }

        .error-screen p {
            color: #cb2431;
            margin-bottom: 16px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
            }
            .question-card {
                padding: 20px 16px;
            }
            .results-breakdown {
                flex-direction: column;
                gap: 16px;
            }
            .start-screen h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="loading" id="loading">Caricamento...</div>
    </div>

    <script>
    (function() {
        const app = document.getElementById('app');
        let questions = [];
        let quiz = null;
        let wrongIds = [];
        const STORAGE_KEY = 'quiz_genetica_wrong';

        function loadWrong() {
            try {
                wrongIds = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch(e) { wrongIds = []; }
        }

        function saveWrong() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(wrongIds));
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function render(html) {
            app.innerHTML = html;
        }

        function showStart() {
            loadWrong();
            const wrongDisabled = wrongIds.length === 0 ? 'disabled' : '';
            render(`
                <div class="start-screen">
                    <h1>Genetica Medica</h1>
                    <p>Quiz di preparazione all'esame</p>
                    <div class="mode-select">
                        <div class="mode-option selected" data-mode="all">
                            <strong>Tutte le domande</strong>
                            <span>${questions.length} domande in ordine casuale</span>
                        </div>
                        <div class="mode-option" data-mode="20">
                            <strong>Simulazione rapida</strong>
                            <span>20 domande casuali</span>
                        </div>
                        <div class="mode-option ${wrongDisabled}" data-mode="wrong">
                            <strong>Ripassa errori</strong>
                            <span>${wrongIds.length} domande da rivedere</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="start-btn">Inizia</button>
                </div>
            `);

            let selectedMode = 'all';
            document.querySelectorAll('.mode-option').forEach(el => {
                el.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    document.querySelectorAll('.mode-option').forEach(e => e.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMode = this.dataset.mode;
                });
            });

            document.getElementById('start-btn').addEventListener('click', () => startQuiz(selectedMode));
        }

        function startQuiz(mode) {
            let pool;
            if (mode === 'all') {
                pool = shuffle(questions.map((q, i) => i));
            } else if (mode === '20') {
                pool = shuffle(questions.map((q, i) => i)).slice(0, 20);
            } else {
                pool = shuffle(wrongIds.slice());
            }

            quiz = {
                pool: pool,
                current: 0,
                correct: 0,
                mistakes: []
            };

            showQuestion();
        }

        function showQuestion() {
            const idx = quiz.pool[quiz.current];
            const q = questions[idx];
            const opts = shuffle(q.risposte);
            const total = quiz.pool.length;
            const progress = ((quiz.current + 1) / total * 100).toFixed(0);

            render(`
                <header>
                    <h1>Genetica Medica</h1>
                    <div class="stats">
                        <span>${quiz.current + 1} / ${total}</span> Â· 
                        <span>${quiz.correct} corrette</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </header>
                <div class="question-card">
                    <div class="question-number">Domanda ${quiz.current + 1}</div>
                    <div class="question-text">${q.domanda}</div>
                    <div class="options" id="options">
                        ${opts.map(o => `<button class="option" data-answer="${encodeURIComponent(o)}">${o}</button>`).join('')}
                    </div>
                    <div class="feedback" id="feedback"></div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary hidden" id="next-btn">${quiz.current < total - 1 ? 'Prossima' : 'Risultati'}</button>
                    <button class="btn btn-secondary" id="quit-btn">Esci</button>
                </div>
            `);

            document.querySelectorAll('.option').forEach(btn => {
                btn.addEventListener('click', () => handleAnswer(btn, idx));
            });

            document.getElementById('quit-btn').addEventListener('click', showStart);
        }

        function handleAnswer(btn, qIdx) {
            if (btn.classList.contains('disabled')) return;

            const q = questions[qIdx];
            const answer = decodeURIComponent(btn.dataset.answer);
            const isCorrect = answer === q.risposta_corretta;

            document.querySelectorAll('.option').forEach(b => {
                b.classList.add('disabled');
                const ans = decodeURIComponent(b.dataset.answer);
                if (ans === q.risposta_corretta) {
                    b.classList.add(isCorrect ? 'correct' : 'show-correct');
                }
            });

            if (isCorrect) {
                btn.classList.add('correct');
                quiz.correct++;
                const wIdx = wrongIds.indexOf(qIdx);
                if (wIdx > -1) {
                    wrongIds.splice(wIdx, 1);
                    saveWrong();
                }
            } else {
                btn.classList.add('wrong');
                quiz.mistakes.push({
                    domanda: q.domanda,
                    tua: answer,
                    corretta: q.risposta_corretta
                });
                if (!wrongIds.includes(qIdx)) {
                    wrongIds.push(qIdx);
                    saveWrong();
                }
            }

            const feedback = document.getElementById('feedback');
            feedback.classList.add('visible', isCorrect ? 'correct' : 'wrong');
            feedback.textContent = isCorrect ? 'Corretto!' : 'Sbagliato. ' + q.risposta_corretta;

            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('hidden');
            nextBtn.addEventListener('click', () => {
                if (quiz.current < quiz.pool.length - 1) {
                    quiz.current++;
                    showQuestion();
                } else {
                    showResults();
                }
            });
        }

        function showResults() {
            const total = quiz.pool.length;
            const pct = Math.round(quiz.correct / total * 100);
            const wrong = total - quiz.correct;

            let reviewHtml = '';
            if (quiz.mistakes.length > 0) {
                reviewHtml = `
                    <div class="review-section">
                        <h3>Da ripassare</h3>
                        ${quiz.mistakes.map(m => `
                            <div class="review-item">
                                <div class="review-question">${m.domanda}</div>
                                <div class="review-your">Hai risposto: ${m.tua}</div>
                                <div class="review-correct">Corretta: ${m.corretta}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            render(`
                <div class="results">
                    <h2>Risultati</h2>
                    <div class="score">${pct}%</div>
                    <div class="score-label">Punteggio finale</div>
                    <div class="results-breakdown">
                        <div class="breakdown-item">
                            <div class="breakdown-value">${quiz.correct}</div>
                            <div class="breakdown-label">Corrette</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-value">${wrong}</div>
                            <div class="breakdown-label">Errate</div>
                        </div>
                        <div class="breakdown-item">
                            <div class="breakdown-value">${total}</div>
                            <div class="breakdown-label">Totali</div>
                        </div>
                    </div>
                    <div class="actions" style="justify-content: center;">
                        <button class="btn btn-primary" id="restart-btn">Nuovo quiz</button>
                        <button class="btn btn-secondary" id="home-btn">Menu</button>
                    </div>
                    ${reviewHtml}
                </div>
            `);

            document.getElementById('restart-btn').addEventListener('click', () => startQuiz('all'));
            document.getElementById('home-btn').addEventListener('click', showStart);
        }

        // Init
        fetch('domande.json')
            .then(r => {
                if (!r.ok) throw new Error();
                return r.json();
            })
            .then(data => {
                questions = data;
                showStart();
            })
            .catch(() => {
                render(`
                    <div class="error-screen">
                        <p>Impossibile caricare le domande</p>
                        <button class="btn btn-primary" onclick="location.reload()">Riprova</button>
                    </div>
                `);
            });
    })();
    </script>
</body>
</html>
