<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz SSM - Specializzazioni Mediche</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            line-height: 1.5;
            min-height: 100vh;
        }
        .container { max-width: 720px; margin: 0 auto; padding: 24px 16px; }
        header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0; }
        header h1 { font-size: 1.25rem; font-weight: 600; margin-bottom: 4px; }
        .stats { font-size: 0.875rem; color: #666; }
        .materia-tag { display: inline-block; background: #e8f4fd; color: #0969da; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 8px; }
        .progress-bar { height: 3px; background: #e0e0e0; margin-top: 12px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #1a1a1a; transition: width 0.3s ease; }
        .question-card { background: #fff; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 16px; }
        .question-number { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; margin-bottom: 8px; }
        .question-text { font-size: 1.125rem; font-weight: 500; margin-bottom: 20px; }
        .options { display: flex; flex-direction: column; gap: 8px; }
        .option { padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; transition: all 0.15s ease; font-size: 0.9375rem; text-align: left; background: #fff; }
        .option:hover:not(.disabled) { border-color: #999; background: #fafafa; }
        .option.correct { border-color: #22863a; background: #dcffe4; color: #22863a; }
        .option.wrong { border-color: #cb2431; background: #ffeef0; color: #cb2431; }
        .option.show-correct { border-color: #22863a; background: #dcffe4; }
        .option.disabled { cursor: default; }
        .feedback { margin-top: 16px; padding: 12px 16px; border-radius: 6px; font-size: 0.875rem; display: none; }
        .feedback.visible { display: block; }
        .feedback.correct { background: #dcffe4; color: #22863a; }
        .feedback.wrong { background: #ffeef0; color: #cb2431; }
        .commento { margin-top: 12px; padding: 12px 16px; background: #f6f8fa; border-radius: 6px; font-size: 0.875rem; color: #444; display: none; }
        .commento.visible { display: block; }
        .commento strong { color: #1a1a1a; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease; }
        .btn-primary { background: #1a1a1a; color: #fff; }
        .btn-primary:hover { background: #333; }
        .btn-secondary { background: #fff; color: #1a1a1a; border: 1px solid #e0e0e0; }
        .btn-secondary:hover { background: #f5f5f5; }
        .btn-danger { background: #cb2431; color: #fff; }
        .btn-danger:hover { background: #a51d28; }
        .btn-small { padding: 8px 16px; font-size: 0.8125rem; }
        .actions { display: flex; gap: 12px; margin-top: 20px; }
        .results { text-align: center; padding: 48px 24px; }
        .results h2 { font-size: 1.75rem; margin-bottom: 8px; }
        .score { font-size: 3rem; font-weight: 700; margin: 24px 0; }
        .score-label { color: #666; font-size: 0.875rem; }
        .results-breakdown { display: flex; justify-content: center; gap: 32px; margin: 24px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; }
        .breakdown-item { text-align: center; }
        .breakdown-value { font-size: 1.5rem; font-weight: 600; }
        .breakdown-label { font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; }
        .start-screen { text-align: center; padding: 48px 24px; }
        .start-screen h1 { font-size: 2rem; margin-bottom: 8px; }
        .start-screen .subtitle { color: #666; margin-bottom: 32px; }
        .mode-select { display: flex; flex-direction: column; gap: 12px; max-width: 320px; margin: 0 auto 24px; }
        .mode-option { padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.15s ease; text-align: left; background: #fff; }
        .mode-option:hover:not(.disabled) { border-color: #999; }
        .mode-option.selected { border-color: #1a1a1a; background: #f5f5f5; }
        .mode-option.disabled { opacity: 0.4; pointer-events: none; }
        .mode-option strong { display: block; margin-bottom: 2px; }
        .mode-option span { font-size: 0.8125rem; color: #666; }
        .hidden { display: none !important; }
        .review-section { margin-top: 32px; text-align: left; }
        .review-section h3 { font-size: 1rem; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0; }
        .review-item { padding: 16px; background: #fff; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #cb2431; }
        .review-question { font-weight: 500; margin-bottom: 8px; font-size: 0.9375rem; }
        .review-materia { font-size: 0.75rem; color: #0969da; margin-bottom: 8px; }
        .review-your { font-size: 0.8125rem; color: #cb2431; margin-bottom: 4px; }
        .review-correct { font-size: 0.8125rem; color: #22863a; margin-bottom: 8px; }
        .review-commento { font-size: 0.8125rem; color: #666; padding-top: 8px; border-top: 1px solid #eee; }
        .loading { text-align: center; padding: 80px 24px; color: #666; }
        .error-screen { text-align: center; padding: 80px 24px; }
        .error-screen p { color: #cb2431; margin-bottom: 16px; }
        .materie-filter { margin-top: 24px; padding: 16px; background: #fff; border-radius: 8px; text-align: left; }
        .materie-filter h4 { font-size: 0.875rem; margin-bottom: 12px; }
        .materie-grid { display: flex; flex-wrap: wrap; gap: 6px; max-height: 200px; overflow-y: auto; }
        .materia-chip { padding: 4px 10px; border: 1px solid #e0e0e0; border-radius: 16px; font-size: 0.75rem; cursor: pointer; transition: all 0.15s ease; }
        .materia-chip:hover { border-color: #999; }
        .materia-chip.selected { background: #1a1a1a; color: #fff; border-color: #1a1a1a; }
        .filter-actions { margin-top: 12px; display: flex; gap: 8px; }
        .filter-actions button { font-size: 0.75rem; padding: 4px 8px; }
        .question-image { margin: 16px 0; text-align: center; }
        .question-image img { max-width: 100%; max-height: 300px; border-radius: 6px; cursor: pointer; border: 1px solid #e0e0e0; }
        .question-image img:hover { border-color: #999; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal.visible { display: flex; }
        .modal img { max-width: 95%; max-height: 95%; object-fit: contain; }
        .modal-close { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 2rem; cursor: pointer; }
        .review-image { margin: 8px 0; }
        .review-image img { max-width: 100%; max-height: 150px; border-radius: 4px; }

        /* Stats styles */
        .stats-screen { padding: 24px 0; }
        .stats-screen h1 { font-size: 1.5rem; margin-bottom: 8px; text-align: center; }
        .stats-screen .subtitle { color: #666; margin-bottom: 24px; text-align: center; font-size: 0.875rem; }
        .stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .stats-summary-item { background: #fff; padding: 16px; border-radius: 8px; text-align: center; }
        .stats-summary-value { font-size: 1.5rem; font-weight: 700; }
        .stats-summary-label { font-size: 0.75rem; color: #666; text-transform: uppercase; }
        .stats-section { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 16px; }
        .stats-section h3 { font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
        .stats-section h3 .toggle { font-size: 0.75rem; color: #0969da; cursor: pointer; }
        .stat-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .stat-row:last-child { border-bottom: none; }
        .stat-name { flex: 1; font-size: 0.875rem; min-width: 0; }
        .stat-name span { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-bar-container { width: 120px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
        .stat-bar { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .stat-bar.good { background: #22863a; }
        .stat-bar.medium { background: #dbab09; }
        .stat-bar.bad { background: #cb2431; }
        .stat-value { width: 60px; text-align: right; font-size: 0.8125rem; font-weight: 500; }
        .stat-count { width: 40px; text-align: right; font-size: 0.75rem; color: #888; }
        .weak-areas { background: #ffeef0; border: 1px solid #ffcdd2; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
        .weak-areas h3 { color: #cb2431; font-size: 0.875rem; margin-bottom: 12px; }
        .weak-areas ul { list-style: none; }
        .weak-areas li { padding: 6px 0; font-size: 0.875rem; border-bottom: 1px solid #ffcdd2; display: flex; justify-content: space-between; }
        .weak-areas li:last-child { border-bottom: none; }
        .weak-areas .weak-pct { color: #cb2431; font-weight: 500; }
        .no-stats { text-align: center; padding: 40px; color: #888; }
        .argomenti-list { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .argomenti-list.expanded { max-height: 1000px; }
        .argomenti-list .stat-row { padding-left: 16px; background: #fafafa; }
        .argomenti-list .stat-name { font-size: 0.8125rem; color: #666; }
        .practice-weak-btn { margin-top: 12px; }

        /* Auth styles */
        .auth-header { display: flex; justify-content: flex-end; padding: 12px 0; margin-bottom: 8px; }
        .auth-btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.875rem; transition: all 0.15s ease; }
        .auth-btn:hover { background: #f5f5f5; border-color: #999; }
        .auth-btn img { width: 18px; height: 18px; }
        .auth-btn.logout { border-color: #ffcdd2; color: #cb2431; }
        .auth-btn.logout:hover { background: #ffeef0; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-email { font-size: 0.8125rem; color: #666; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sync-indicator { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #888; }
        .sync-indicator.syncing { color: #0969da; }
        .sync-indicator.synced { color: #22863a; }
        .sync-indicator.offline { color: #cb2431; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .sync-indicator.syncing .sync-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .google-icon { width: 18px; height: 18px; }

        @media (max-width: 480px) {
            .container { padding: 16px 12px; }
            .question-card { padding: 20px 16px; }
            .results-breakdown { flex-direction: column; gap: 16px; }
            .start-screen h1 { font-size: 1.5rem; }
            .stats-summary { grid-template-columns: 1fr; }
            .stat-bar-container { width: 80px; }
            .user-email { max-width: 100px; }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="loading">Caricamento domande...</div>
    </div>

    <script>
    (function() {
        const app = document.getElementById('app');
        let questions = [];
        let materie = [];
        let argomenti = {};
        let quiz = null;
        let wrongIds = [];
        let selectedMaterie = [];
        let statsData = { materie: {}, argomenti: {} };

        const STORAGE_KEY = 'quiz_ssm_wrong';
        const STATS_KEY = 'quiz_ssm_stats';

        // Supabase configuration
        const SUPABASE_URL = 'https://obckabzhhzcpxajaxxjo.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Nv_TRfwJuYUJ9gB-m6EKCA_Xfc_PX13';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let syncStatus = 'offline'; // 'offline', 'syncing', 'synced'
        let syncTimeout = null;

        // Auth functions
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await syncFromCloud();
            }

            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await syncFromCloud();
                    showStart();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    syncStatus = 'offline';
                    showStart();
                }
            });
        }

        async function loginWithGoogle() {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + window.location.pathname
                }
            });
            if (error) {
                console.error('Login error:', error);
                alert('Errore durante il login: ' + error.message);
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            syncStatus = 'offline';
        }

        // Sync functions
        async function syncFromCloud() {
            if (!currentUser) return;

            syncStatus = 'syncing';
            updateSyncIndicator();

            try {
                const { data, error } = await supabase
                    .from('user_progress')
                    .select('stats_data, wrong_ids')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows
                    throw error;
                }

                if (data) {
                    // Merge cloud data with local
                    const cloudStats = data.stats_data || { materie: {}, argomenti: {} };
                    const cloudWrong = data.wrong_ids || [];

                    statsData = mergeStats(statsData, cloudStats);
                    wrongIds = mergeWrongIds(wrongIds, cloudWrong);

                    saveStats();
                    saveWrong();
                }

                // Push merged data back to cloud
                await syncToCloud();
                syncStatus = 'synced';
            } catch (err) {
                console.error('Sync from cloud error:', err);
                syncStatus = 'offline';
            }

            updateSyncIndicator();
        }

        async function syncToCloud() {
            if (!currentUser) return;

            try {
                const { error } = await supabase
                    .from('user_progress')
                    .upsert({
                        user_id: currentUser.id,
                        stats_data: statsData,
                        wrong_ids: wrongIds,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;
                syncStatus = 'synced';
            } catch (err) {
                console.error('Sync to cloud error:', err);
                syncStatus = 'offline';
            }

            updateSyncIndicator();
        }

        function debouncedSync() {
            if (!currentUser) return;

            if (syncTimeout) clearTimeout(syncTimeout);
            syncStatus = 'syncing';
            updateSyncIndicator();

            syncTimeout = setTimeout(() => {
                syncToCloud();
            }, 2000); // Wait 2 seconds before syncing
        }

        function mergeStats(local, cloud) {
            const merged = { materie: {}, argomenti: {} };

            // Merge materie
            const allMaterie = new Set([...Object.keys(local.materie || {}), ...Object.keys(cloud.materie || {})]);
            allMaterie.forEach(m => {
                const localM = (local.materie || {})[m] || { correct: 0, total: 0 };
                const cloudM = (cloud.materie || {})[m] || { correct: 0, total: 0 };
                merged.materie[m] = {
                    correct: Math.max(localM.correct, cloudM.correct),
                    total: Math.max(localM.total, cloudM.total)
                };
            });

            // Merge argomenti
            const allArg = new Set([...Object.keys(local.argomenti || {}), ...Object.keys(cloud.argomenti || {})]);
            allArg.forEach(a => {
                const localA = (local.argomenti || {})[a] || { correct: 0, total: 0, materia: '', argomento: '' };
                const cloudA = (cloud.argomenti || {})[a] || { correct: 0, total: 0, materia: '', argomento: '' };
                merged.argomenti[a] = {
                    correct: Math.max(localA.correct, cloudA.correct),
                    total: Math.max(localA.total, cloudA.total),
                    materia: localA.materia || cloudA.materia,
                    argomento: localA.argomento || cloudA.argomento
                };
            });

            return merged;
        }

        function mergeWrongIds(local, cloud) {
            return [...new Set([...local, ...cloud])];
        }

        function updateSyncIndicator() {
            const indicator = document.getElementById('sync-indicator');
            if (!indicator) return;

            indicator.className = 'sync-indicator ' + syncStatus;
            const labels = { offline: 'Offline', syncing: 'Sincronizzando...', synced: 'Sincronizzato' };
            indicator.innerHTML = `<span class="sync-dot"></span>${labels[syncStatus]}`;
        }

        function getAuthHeaderHtml() {
            if (currentUser) {
                return `
                    <div class="auth-header">
                        <div class="user-info">
                            <span id="sync-indicator" class="sync-indicator ${syncStatus}">
                                <span class="sync-dot"></span>${syncStatus === 'synced' ? 'Sincronizzato' : syncStatus === 'syncing' ? 'Sincronizzando...' : 'Offline'}
                            </span>
                            <span class="user-email" title="${currentUser.email}">${currentUser.email}</span>
                            <button class="auth-btn logout" onclick="window.doLogout()">Esci</button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="auth-header">
                        <button class="auth-btn" onclick="window.doLogin()">
                            <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            Accedi con Google
                        </button>
                    </div>
                `;
            }
        }

        window.doLogin = loginWithGoogle;
        window.doLogout = logout;

        function loadWrong() {
            try { wrongIds = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
            catch(e) { wrongIds = []; }
        }

        function saveWrong() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(wrongIds));
            debouncedSync();
        }

        function loadStats() {
            try {
                const saved = JSON.parse(localStorage.getItem(STATS_KEY));
                if (saved) statsData = saved;
            } catch(e) {
                statsData = { materie: {}, argomenti: {} };
            }
        }

        function saveStats() {
            localStorage.setItem(STATS_KEY, JSON.stringify(statsData));
            debouncedSync();
        }

        function recordAnswer(materia, argomento, isCorrect) {
            // Materia stats
            if (!statsData.materie[materia]) {
                statsData.materie[materia] = { correct: 0, total: 0 };
            }
            statsData.materie[materia].total++;
            if (isCorrect) statsData.materie[materia].correct++;

            // Argomento stats
            const argKey = `${materia}|||${argomento}`;
            if (!statsData.argomenti[argKey]) {
                statsData.argomenti[argKey] = { correct: 0, total: 0, materia, argomento };
            }
            statsData.argomenti[argKey].total++;
            if (isCorrect) statsData.argomenti[argKey].correct++;

            saveStats();
        }

        function getWeakAreas(threshold = 60, minAnswers = 3) {
            const weak = [];

            // Check materie
            Object.entries(statsData.materie).forEach(([name, data]) => {
                if (data.total >= minAnswers) {
                    const pct = Math.round(data.correct / data.total * 100);
                    if (pct < threshold) {
                        weak.push({ type: 'materia', name, pct, total: data.total });
                    }
                }
            });

            // Check argomenti
            Object.entries(statsData.argomenti).forEach(([key, data]) => {
                if (data.total >= minAnswers) {
                    const pct = Math.round(data.correct / data.total * 100);
                    if (pct < threshold) {
                        weak.push({ type: 'argomento', name: data.argomento, materia: data.materia, pct, total: data.total });
                    }
                }
            });

            return weak.sort((a, b) => a.pct - b.pct);
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function render(html) { app.innerHTML = html; }

        window.openModal = function(src) {
            const modal = document.getElementById('modal');
            const modalImg = document.getElementById('modal-img');
            if (modal && modalImg) {
                modalImg.src = src;
                modal.classList.add('visible');
            }
        };

        window.closeModal = function() {
            const modal = document.getElementById('modal');
            if (modal) modal.classList.remove('visible');
        };

        function showStart() {
            loadWrong();
            loadStats();
            const wrongDisabled = wrongIds.length === 0 ? 'disabled' : '';
            const weakAreas = getWeakAreas();
            const hasStats = Object.keys(statsData.materie).length > 0;

            render(`
                ${getAuthHeaderHtml()}
                <div class="start-screen">
                    <h1>SSM Simulator</h1>
                    <p class="subtitle">Quiz di preparazione alle Specializzazioni Mediche</p>
                    <div class="mode-select">
                        <div class="mode-option selected" data-mode="140">
                            <strong>Simulazione SSM</strong>
                            <span>140 domande come nel concorso</span>
                        </div>
                        <div class="mode-option" data-mode="20">
                            <strong>Esercitazione rapida</strong>
                            <span>20 domande casuali</span>
                        </div>
                        <div class="mode-option" data-mode="custom">
                            <strong>Personalizzato</strong>
                            <span>Scegli materie e numero</span>
                        </div>
                        <div class="mode-option ${wrongDisabled}" data-mode="wrong">
                            <strong>Ripassa errori</strong>
                            <span>${wrongIds.length} domande da rivedere</span>
                        </div>
                        ${weakAreas.length > 0 ? `
                        <div class="mode-option" data-mode="weak" style="border-color:#cb2431;">
                            <strong style="color:#cb2431;">Rinforza punti deboli</strong>
                            <span>${weakAreas.length} aree sotto il 60%</span>
                        </div>
                        ` : ''}
                    </div>
                    <button class="btn btn-primary" id="start-btn">Inizia</button>
                    ${hasStats ? `<button class="btn btn-secondary" id="stats-btn" style="margin-left:12px;">Statistiche</button>` : ''}
                    <p style="margin-top:24px;font-size:0.8rem;color:#888;">${questions.length} domande disponibili</p>
                </div>
            `);

            let selectedMode = '140';
            document.querySelectorAll('.mode-option').forEach(el => {
                el.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    document.querySelectorAll('.mode-option').forEach(e => e.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMode = this.dataset.mode;
                });
            });

            document.getElementById('start-btn').addEventListener('click', () => {
                if (selectedMode === 'custom') {
                    showCustomSetup();
                } else if (selectedMode === 'weak') {
                    startWeakAreasQuiz();
                } else {
                    startQuiz(selectedMode);
                }
            });

            const statsBtn = document.getElementById('stats-btn');
            if (statsBtn) {
                statsBtn.addEventListener('click', showStats);
            }
        }

        function showStats() {
            loadStats();
            const totalAnswered = Object.values(statsData.materie).reduce((sum, m) => sum + m.total, 0);
            const totalCorrect = Object.values(statsData.materie).reduce((sum, m) => sum + m.correct, 0);
            const overallPct = totalAnswered > 0 ? Math.round(totalCorrect / totalAnswered * 100) : 0;
            const weakAreas = getWeakAreas();

            // Sort materie by percentage (ascending = worst first)
            const materieStats = Object.entries(statsData.materie)
                .map(([name, data]) => ({
                    name,
                    correct: data.correct,
                    total: data.total,
                    pct: Math.round(data.correct / data.total * 100)
                }))
                .sort((a, b) => a.pct - b.pct);

            // Group argomenti by materia
            const argomentiByMateria = {};
            Object.entries(statsData.argomenti).forEach(([key, data]) => {
                if (!argomentiByMateria[data.materia]) {
                    argomentiByMateria[data.materia] = [];
                }
                argomentiByMateria[data.materia].push({
                    name: data.argomento,
                    correct: data.correct,
                    total: data.total,
                    pct: Math.round(data.correct / data.total * 100)
                });
            });

            // Sort argomenti within each materia
            Object.keys(argomentiByMateria).forEach(m => {
                argomentiByMateria[m].sort((a, b) => a.pct - b.pct);
            });

            function getBarClass(pct) {
                if (pct >= 70) return 'good';
                if (pct >= 50) return 'medium';
                return 'bad';
            }

            let weakHtml = '';
            if (weakAreas.length > 0) {
                weakHtml = `
                    <div class="weak-areas">
                        <h3>Aree da ripassare (sotto 60%)</h3>
                        <ul>
                            ${weakAreas.slice(0, 8).map(w => `
                                <li>
                                    <span>${w.type === 'argomento' ? `${w.materia} → ${w.name}` : w.name}</span>
                                    <span class="weak-pct">${w.pct}% (${w.total} risposte)</span>
                                </li>
                            `).join('')}
                        </ul>
                        <button class="btn btn-primary btn-small practice-weak-btn" id="practice-weak-btn">Esercitati su questi argomenti</button>
                    </div>
                `;
            }

            let materieHtml = '';
            if (materieStats.length > 0) {
                materieHtml = `
                    <div class="stats-section">
                        <h3>Performance per Materia</h3>
                        ${materieStats.map(m => `
                            <div class="stat-row materia-row" data-materia="${encodeURIComponent(m.name)}">
                                <div class="stat-name"><span title="${m.name}">${m.name}</span></div>
                                <div class="stat-bar-container">
                                    <div class="stat-bar ${getBarClass(m.pct)}" style="width:${m.pct}%"></div>
                                </div>
                                <div class="stat-value">${m.pct}%</div>
                                <div class="stat-count">${m.total}</div>
                            </div>
                            <div class="argomenti-list" id="arg-${encodeURIComponent(m.name)}">
                                ${(argomentiByMateria[m.name] || []).map(a => `
                                    <div class="stat-row">
                                        <div class="stat-name"><span title="${a.name}">${a.name}</span></div>
                                        <div class="stat-bar-container">
                                            <div class="stat-bar ${getBarClass(a.pct)}" style="width:${a.pct}%"></div>
                                        </div>
                                        <div class="stat-value">${a.pct}%</div>
                                        <div class="stat-count">${a.total}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                        <p style="margin-top:12px;font-size:0.75rem;color:#888;">Clicca su una materia per vedere gli argomenti</p>
                    </div>
                `;
            }

            render(`
                ${getAuthHeaderHtml()}
                <div class="stats-screen">
                    <h1>Statistiche</h1>
                    <p class="subtitle">Analisi delle tue performance</p>

                    <div class="stats-summary">
                        <div class="stats-summary-item">
                            <div class="stats-summary-value">${totalAnswered}</div>
                            <div class="stats-summary-label">Risposte totali</div>
                        </div>
                        <div class="stats-summary-item">
                            <div class="stats-summary-value">${overallPct}%</div>
                            <div class="stats-summary-label">Media generale</div>
                        </div>
                        <div class="stats-summary-item">
                            <div class="stats-summary-value">${materieStats.length}</div>
                            <div class="stats-summary-label">Materie studiate</div>
                        </div>
                    </div>

                    ${weakHtml}
                    ${materieHtml}

                    ${totalAnswered === 0 ? '<div class="no-stats">Nessuna statistica ancora. Inizia un quiz!</div>' : ''}

                    <div class="actions" style="justify-content:center;margin-top:24px;">
                        <button class="btn btn-secondary" id="back-btn">Torna al menu</button>
                        ${totalAnswered > 0 ? '<button class="btn btn-danger btn-small" id="reset-stats-btn">Azzera statistiche</button>' : ''}
                    </div>
                </div>
            `);

            document.getElementById('back-btn').addEventListener('click', showStart);

            const resetBtn = document.getElementById('reset-stats-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm('Sei sicuro di voler azzerare tutte le statistiche?')) {
                        statsData = { materie: {}, argomenti: {} };
                        saveStats();
                        showStats();
                    }
                });
            }

            const practiceWeakBtn = document.getElementById('practice-weak-btn');
            if (practiceWeakBtn) {
                practiceWeakBtn.addEventListener('click', startWeakAreasQuiz);
            }

            // Toggle argomenti visibility
            document.querySelectorAll('.materia-row').forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('click', function() {
                    const materia = decodeURIComponent(this.dataset.materia);
                    const argList = document.getElementById('arg-' + encodeURIComponent(materia));
                    if (argList) {
                        argList.classList.toggle('expanded');
                    }
                });
            });
        }

        function startWeakAreasQuiz() {
            const weakAreas = getWeakAreas();
            const weakMaterie = new Set();
            const weakArgomenti = new Set();

            weakAreas.forEach(w => {
                if (w.type === 'materia') {
                    weakMaterie.add(w.name);
                } else {
                    weakArgomenti.add(`${w.materia}|||${w.argomento}`);
                }
            });

            // Get questions from weak areas
            let pool = questions.map((q, i) => i).filter(i => {
                const q = questions[i];
                const argKey = `${q.materia}|||${q.argomenti}`;
                return weakMaterie.has(q.materia) || weakArgomenti.has(argKey);
            });

            if (pool.length === 0) {
                alert('Nessuna domanda disponibile per le aree deboli');
                showStart();
                return;
            }

            pool = shuffle(pool).slice(0, Math.min(30, pool.length));
            quiz = { pool, current: 0, correct: 0, mistakes: [] };
            showQuestion();
        }

        function showCustomSetup() {
            selectedMaterie = [];
            render(`
                ${getAuthHeaderHtml()}
                <div class="start-screen">
                    <h1>Quiz Personalizzato</h1>
                    <p class="subtitle">Seleziona le materie da includere</p>
                    <div class="materie-filter">
                        <div class="filter-actions">
                            <button class="btn btn-secondary" id="select-all">Tutte</button>
                            <button class="btn btn-secondary" id="select-none">Nessuna</button>
                        </div>
                        <div class="materie-grid" id="materie-grid" style="margin-top:12px;">
                            ${materie.map(m => `<span class="materia-chip" data-materia="${encodeURIComponent(m)}">${m}</span>`).join('')}
                        </div>
                    </div>
                    <div style="margin-top:24px;">
                        <label style="font-size:0.875rem;">Numero domande: <strong id="num-display">50</strong></label>
                        <input type="range" id="num-slider" min="10" max="140" value="50" style="width:100%;margin-top:8px;">
                    </div>
                    <div class="actions" style="justify-content:center;margin-top:24px;">
                        <button class="btn btn-secondary" id="back-btn">Indietro</button>
                        <button class="btn btn-primary" id="start-custom-btn">Inizia</button>
                    </div>
                </div>
            `);

            const slider = document.getElementById('num-slider');
            const numDisplay = document.getElementById('num-display');
            slider.addEventListener('input', () => numDisplay.textContent = slider.value);

            document.querySelectorAll('.materia-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const m = decodeURIComponent(this.dataset.materia);
                    if (this.classList.contains('selected')) {
                        selectedMaterie.push(m);
                    } else {
                        selectedMaterie = selectedMaterie.filter(x => x !== m);
                    }
                });
            });

            document.getElementById('select-all').addEventListener('click', () => {
                selectedMaterie = [...materie];
                document.querySelectorAll('.materia-chip').forEach(c => c.classList.add('selected'));
            });

            document.getElementById('select-none').addEventListener('click', () => {
                selectedMaterie = [];
                document.querySelectorAll('.materia-chip').forEach(c => c.classList.remove('selected'));
            });

            document.getElementById('back-btn').addEventListener('click', showStart);
            document.getElementById('start-custom-btn').addEventListener('click', () => {
                const num = parseInt(slider.value);
                startQuiz('custom', num, selectedMaterie);
            });
        }

        function startQuiz(mode, customNum = 0, customMaterie = []) {
            let pool;
            if (mode === '140') {
                pool = shuffle(questions.map((q, i) => i)).slice(0, 140);
            } else if (mode === '20') {
                pool = shuffle(questions.map((q, i) => i)).slice(0, 20);
            } else if (mode === 'wrong') {
                pool = shuffle(wrongIds.slice());
            } else if (mode === 'custom') {
                let filtered = questions.map((q, i) => i);
                if (customMaterie.length > 0) {
                    filtered = filtered.filter(i => customMaterie.includes(questions[i].materia));
                }
                pool = shuffle(filtered).slice(0, Math.min(customNum, filtered.length));
            }

            if (pool.length === 0) {
                alert('Nessuna domanda disponibile per i criteri selezionati');
                showStart();
                return;
            }

            quiz = { pool, current: 0, correct: 0, mistakes: [] };
            showQuestion();
        }

        function showQuestion() {
            const idx = quiz.pool[quiz.current];
            const q = questions[idx];
            const opts = shuffle(q.risposte.slice());
            const total = quiz.pool.length;
            const progress = ((quiz.current + 1) / total * 100).toFixed(0);

            render(`
                <header>
                    <h1>SSM Simulator <span class="materia-tag">${q.materia}</span></h1>
                    <div class="stats">
                        <span>${quiz.current + 1} / ${total}</span> · <span>${quiz.correct} corrette</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                </header>
                <div class="question-card">
                    <div class="question-number">Domanda ${quiz.current + 1} · ${q.argomenti}</div>
                    <div class="question-text">${q.domanda}</div>
                    ${q.has_image && q.image_src ? `<div class="question-image"><img src="${q.image_src}" alt="Immagine domanda" onclick="openModal(this.src)"></div>` : ''}
                    <div class="options" id="options">
                        ${opts.map(o => `<button class="option" data-id="${o.id}" data-correct="${o.isCorrect}">${o.text}</button>`).join('')}
                    </div>
                    <div class="feedback" id="feedback"></div>
                    <div class="commento" id="commento"></div>
                </div>
                <div class="modal" id="modal" onclick="closeModal()">
                    <span class="modal-close">&times;</span>
                    <img id="modal-img" src="" alt="Immagine ingrandita">
                </div>
                <div class="actions">
                    <button class="btn btn-primary hidden" id="next-btn">${quiz.current < total - 1 ? 'Prossima' : 'Risultati'}</button>
                    <button class="btn btn-secondary" id="quit-btn">Esci</button>
                </div>
            `);

            document.querySelectorAll('.option').forEach(btn => {
                btn.addEventListener('click', () => handleAnswer(btn, idx, q));
            });
            document.getElementById('quit-btn').addEventListener('click', showStart);
        }

        function handleAnswer(btn, qIdx, q) {
            if (btn.classList.contains('disabled')) return;

            const isCorrect = btn.dataset.correct === 'true';
            const userAnswer = btn.textContent;

            // Record stats
            recordAnswer(q.materia, q.argomenti, isCorrect);

            document.querySelectorAll('.option').forEach(b => {
                b.classList.add('disabled');
                if (b.dataset.correct === 'true') {
                    b.classList.add(isCorrect ? 'correct' : 'show-correct');
                }
            });

            if (isCorrect) {
                btn.classList.add('correct');
                quiz.correct++;
                const wIdx = wrongIds.indexOf(qIdx);
                if (wIdx > -1) { wrongIds.splice(wIdx, 1); saveWrong(); }
            } else {
                btn.classList.add('wrong');
                quiz.mistakes.push({
                    domanda: q.domanda,
                    materia: q.materia,
                    argomento: q.argomenti,
                    tua: userAnswer,
                    corretta: q.risposta_corretta_text,
                    commento: q.commento,
                    has_image: q.has_image,
                    image_src: q.image_src
                });
                if (!wrongIds.includes(qIdx)) { wrongIds.push(qIdx); saveWrong(); }
            }

            const feedback = document.getElementById('feedback');
            feedback.classList.add('visible', isCorrect ? 'correct' : 'wrong');
            feedback.textContent = isCorrect ? 'Corretto!' : 'Sbagliato. ' + q.risposta_corretta_text;

            if (q.commento) {
                const commento = document.getElementById('commento');
                commento.classList.add('visible');
                commento.innerHTML = '<strong>Spiegazione:</strong> ' + q.commento;
            }

            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('hidden');
            nextBtn.addEventListener('click', () => {
                if (quiz.current < quiz.pool.length - 1) {
                    quiz.current++;
                    showQuestion();
                } else {
                    showResults();
                }
            });
        }

        function showResults() {
            const total = quiz.pool.length;
            const pct = Math.round(quiz.correct / total * 100);
            const wrong = total - quiz.correct;

            let reviewHtml = '';
            if (quiz.mistakes.length > 0) {
                reviewHtml = `
                    <div class="review-section">
                        <h3>Da ripassare (${quiz.mistakes.length})</h3>
                        ${quiz.mistakes.map(m => `
                            <div class="review-item">
                                <div class="review-materia">${m.materia} → ${m.argomento}</div>
                                <div class="review-question">${m.domanda}</div>
                                ${m.has_image && m.image_src ? `<div class="review-image"><img src="${m.image_src}" alt="Immagine"></div>` : ''}
                                <div class="review-your">Hai risposto: ${m.tua}</div>
                                <div class="review-correct">Corretta: ${m.corretta}</div>
                                ${m.commento ? `<div class="review-commento">${m.commento}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            render(`
                ${getAuthHeaderHtml()}
                <div class="results">
                    <h2>Risultati</h2>
                    <div class="score">${pct}%</div>
                    <div class="score-label">Punteggio finale</div>
                    <div class="results-breakdown">
                        <div class="breakdown-item"><div class="breakdown-value">${quiz.correct}</div><div class="breakdown-label">Corrette</div></div>
                        <div class="breakdown-item"><div class="breakdown-value">${wrong}</div><div class="breakdown-label">Errate</div></div>
                        <div class="breakdown-item"><div class="breakdown-value">${total}</div><div class="breakdown-label">Totali</div></div>
                    </div>
                    <div class="actions" style="justify-content:center;">
                        <button class="btn btn-primary" id="restart-btn">Nuovo quiz</button>
                        <button class="btn btn-secondary" id="stats-btn">Statistiche</button>
                        <button class="btn btn-secondary" id="home-btn">Menu</button>
                    </div>
                    ${reviewHtml}
                </div>
            `);

            document.getElementById('restart-btn').addEventListener('click', () => startQuiz('20'));
            document.getElementById('stats-btn').addEventListener('click', showStats);
            document.getElementById('home-btn').addEventListener('click', showStart);
        }

        // Load JSONL
        fetch('domande_unite_no_duplicati.jsonl')
            .then(r => {
                if (!r.ok) throw new Error();
                return r.text();
            })
            .then(text => {
                const lines = text.trim().split('\n').filter(l => l.trim());
                questions = lines.map((line, i) => {
                    const q = JSON.parse(line);
                    q._idx = i;
                    return q;
                });
                materie = [...new Set(questions.map(q => q.materia))].sort();

                // Build argomenti map
                questions.forEach(q => {
                    if (!argomenti[q.materia]) argomenti[q.materia] = new Set();
                    argomenti[q.materia].add(q.argomenti);
                });

                loadStats();
                initAuth().then(() => showStart());
            })
            .catch(() => {
                render(`
                    <div class="error-screen">
                        <p>Impossibile caricare le domande</p>
                        <button class="btn btn-primary" onclick="location.reload()">Riprova</button>
                    </div>
                `);
            });
    })();
    </script>
</body>
</html>
